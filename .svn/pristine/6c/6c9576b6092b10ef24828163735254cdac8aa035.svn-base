package cn.com.cdboost.collect.controller;

import cn.com.cdboost.collect.service.AppChargerService;
import cn.com.cdboost.collect.service.WxChargerPayService;
import cn.com.cdboost.collect.util.XMLBeanUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.RequestMapping;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.Map;

@Controller
@RequestMapping(value = "/back")
public class WxChargerBackController {
    private static final Logger logger = LoggerFactory.getLogger(WxChargerBackController.class);
    @Autowired
    AppChargerService appChargerService;
    @Autowired
    WxChargerPayService wxChargerPayService;
    /**
     * 微信支付通知
     * @return
     */
    @RequestMapping(value = "/notify")
    public String notify(HttpServletRequest request, HttpServletResponse response) throws Exception{
        logger.info("~~~~~~~~~~~~~~~~微信支付通知来啦~~~~~~~~~");
        System.out.println("~~~~~~~~~~~~~~~~微信支付通知来啦~~~~~~~~~");
        InputStream inStream = request.getInputStream();
        ByteArrayOutputStream outSteam = new ByteArrayOutputStream();
        byte[] buffer = new byte[1024];
        int len = 0;
        while ((len = inStream.read(buffer)) != -1) {
            outSteam.write(buffer, 0, len);
        }
        outSteam.close();
        inStream.close();

        response.setContentType("text/xml");

        String result = new String(outSteam.toByteArray(), "utf-8");
        if(StringUtils.isEmpty(result))
        {
            String resString =  "<xml><return_code><![CDATA[FAIL]]></return_code><return_msg><![CDATA[非法访问]]></return_msg></xml>";
            response(response,resString);
        }
        System.out.println("通知内容:"+result);
        logger.info("微信支付通知结果--------->"+result);
        Map<String, String> map =  XMLBeanUtils.readStringXmlOut(result);
        logger.info("微信通知结果map类型:-------->"+result);
        if(map.get("result_code").equals("SUCCESS") &&map.get("return_code").equals("SUCCESS"))
        {
            String out_trade_no =  map.get("out_trade_no");
            wxChargerPayService.notify(out_trade_no);
            System.out.println("微信支付通知成功+");
        }
        else
        {
            System.out.println("系统通知内容为支付失败");
        }
        String resString = "<xml><return_code><![CDATA[SUCCESS]]></return_code><return_msg><![CDATA[OK]]></return_msg></xml>";
        response(response,resString);
        return null;
    }
    /**
     * 返回输出
     * @param res
     * @param xml
     * @throws IOException
     */
    private void response(HttpServletResponse res,String xml) throws IOException
    {
        System.out.println(xml);
        res.getWriter().print(xml);
        res.getWriter().flush();
        res.getWriter().close();
    }
}
